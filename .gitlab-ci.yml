stages:
  - pre
  - lint
  - test
  - ui-test

# Workflow configuration for all jobs in this file
# Ref.: https://docs.gitlab.com/ee/ci/yaml/workflow.html
# workflow:
#   rules:
#     - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
#     - if: $CI_COMMIT_TAG
#     - if: $CI_COMMIT_BRANCH == 'develop' || $CI_COMMIT_BRANCH == 'master'

# Tags applied to all jobs
# Ref.: https://docs.gitlab.com/ee/ci/yaml/
default:
  tags:
    - macos:sonoma
    - specific:true

.run:on-code-change:
  rules:
    - changes:
      - "Datadog*/**/*" # covers any change to the SDK code, tests or setup
      - "TestUtilities/**/*"

ENV check:
  stage: pre
  script:
    - ./tools/runner-setup.sh --ios # temporary, waiting for AMI
    - make env-check

Lint:
  stage: lint
  extends:
    - .run:on-code-change
  script:
    - ./tools/runner-setup.sh --ios # temporary, waiting for AMI
    - make clean repo-setup ENV=ci
    - make lint license-check
    - make rum-models-verify sr-models-verify

Unit Tests (iOS):
  stage: test
  extends:
    - .run:on-code-change
  variables:
    OS: "latest"
    PLATFORM: "iOS Simulator"
    DEVICE: "iPhone 15 Pro"
  script:
    - ./tools/runner-setup.sh --ios # temporary, waiting for AMI
    - make clean repo-setup ENV=ci
    - make test-ios-all OS="$OS" PLATFORM="$PLATFORM" DEVICE="$DEVICE"

Unit Tests (tvOS):
  stage: test
  extends:
    - .run:on-code-change
  variables:
    OS: "latest"
    PLATFORM: "tvOS Simulator"
    DEVICE: "Apple TV"
  script:
    - ./tools/runner-setup.sh --tvos # temporary, waiting for AMI
    - make clean repo-setup ENV=ci
    - make test-tvos-all OS="$OS" PLATFORM="$PLATFORM" DEVICE="$DEVICE"

UI Tests:
  stage: ui-test
  extends:
    - .run:on-code-change
  rules:
    - changes:
      - "IntegrationTests/**/*"
  variables:
    OS: "latest"
    PLATFORM: "iOS Simulator"
    DEVICE: "iPhone 15 Pro"
  parallel:
    matrix:
      - TEST_PLAN:
          - Default
          - RUM
          - CrashReporting
          - NetworkInstrumentation
  script:
    - ./tools/runner-setup.sh --ios # temporary, waiting for AMI
    - make clean repo-setup ENV=ci
    - make ui-test TEST_PLAN="$TEST_PLAN" OS="$OS" PLATFORM="$PLATFORM" DEVICE="$DEVICE"
